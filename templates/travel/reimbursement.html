{% extends 'index.html' %}
{% load static %}
{% load i18n %}
{% block content %}

<div class="oh-wrapper">
    <div class="oh-main">
        <div class="oh-main__content">
            <div class="d-flex align-items-center justify-content-between mb-3 mt-4" style="gap: 1rem;">
                <div class="d-flex align-items-center" style="gap: 0.75rem;">
                    <h1 class="oh-main__title mb-0" style="font-size: 1.8rem; font-weight: 700; letter-spacing: -1px;">{% trans "Travel Reimbursements" %}</h1>
                </div>
                <div class="d-flex align-items-center" style="gap: 0.75rem;">
                    <div class="oh-input-group">
                        <input type="search" class="oh-input" placeholder="{% trans 'Search' %}" style="min-width: 220px;" id="reimbursement-search-input">
                    </div>
                    <button class="oh-btn oh-btn--danger" onclick="openReimbursementModal()">
                        <ion-icon name="add-outline" class="me-1"></ion-icon>
                        {% trans "Create" %}
                    </button>
                </div>
            </div>

            <div class="oh-main__body">
                <!-- Quick filters -->
                <div class="d-flex flex-row-reverse mb-2 mt-4">
                    <span class="me-3" style="cursor: pointer">
                        <span class="oh-dot oh-dot--small me-1" style="background-color: red"></span>
                        {% trans "Rejected" %}
                    </span>
                    <span class="me-3" style="cursor: pointer">
                        <span class="oh-dot oh-dot--small me-1" style="background-color: rgba(240, 193, 22, 0.819)"></span>
                        {% trans "Pending" %}
                    </span>
                    <span class="me-3" style="cursor: pointer">
                        <span class="oh-dot oh-dot--small me-1" style="background-color: yellowgreen"></span>
                        {% trans "Success" %}
                    </span>
                </div>

                <!-- Table -->
                <div class="oh-sticky-table">
                    <div class="oh-sticky-table__table">
                        <div class="oh-sticky-table__thead">
                            <div class="oh-sticky-table__tr">
                                <div class="oh-sticky-table__th" style="width: 40px;">
                                    <input type="checkbox" class="oh-checkbox" id="select-all-reimbursements">
                                </div>
                                <div class="oh-sticky-table__th">{% trans "Employee" %}</div>
                                <div class="oh-sticky-table__th">{% trans "Travel Request" %}</div>
                                <div class="oh-sticky-table__th">{% trans "Amount" %}</div>
                                <div class="oh-sticky-table__th">{% trans "Submitted Date" %}</div>
                                <div class="oh-sticky-table__th">{% trans "Status" %}</div>
                                <div class="oh-sticky-table__th">{% trans "Actions" %}</div>
                            </div>
                        </div>
                        <div class="oh-sticky-table__tbody">
                            <!-- Example row 1 -->
                            <div class="oh-sticky-table__tr">
                                <div class="oh-sticky-table__td"><input type="checkbox" class="oh-checkbox row-checkbox-reimbursement"></div>
                                <div class="oh-sticky-table__td">Alice Smith</div>
                                <div class="oh-sticky-table__td">Goa Trip</div>
                                <div class="oh-sticky-table__td">8,000</div>
                                <div class="oh-sticky-table__td">2024-07-21</div>
                                <div class="oh-sticky-table__td">
                                    <span class="oh-status" style="background: #22c55e; color: #fff; border-radius: 12px; padding: 4px 16px; font-size: 0.95em; font-weight: 500;">Success</span>
                                </div>
                                <div class="oh-sticky-table__td ">
                                    <div class="oh-btn-group gap-2">
                                        <button class="oh-btn oh-btn--success oh-btn--small" title="Approve"><ion-icon name="checkmark-outline"></ion-icon></button>
                                        <button class="oh-btn oh-btn--danger oh-btn--small" title="Reject"><ion-icon name="close-outline"></ion-icon></button>
                                    </div>
                                </div>
                            </div>
                            <!-- Example row 2 -->
                            <div class="oh-sticky-table__tr">
                                <div class="oh-sticky-table__td"><input type="checkbox" class="oh-checkbox row-checkbox-reimbursement"></div>
                                <div class="oh-sticky-table__td">John Doe</div>
                                <div class="oh-sticky-table__td">Mumbai Trip</div>
                                <div class="oh-sticky-table__td">5,500</div>
                                <div class="oh-sticky-table__td">2024-07-18</div>
                                <div class="oh-sticky-table__td">
                                    <span class="oh-status" style="background: #facc15; color: #222; border-radius: 12px; padding: 4px 16px; font-size: 0.95em; font-weight: 500;">Pending</span>
                                </div>
                                <div class="oh-sticky-table__td">
                                    <div class="oh-btn-group gap-2">
                                        <button class="oh-btn oh-btn--success oh-btn--small" title="Approve"><ion-icon name="checkmark-outline"></ion-icon></button>
                                        <button class="oh-btn oh-btn--danger oh-btn--small" title="Reject"><ion-icon name="close-outline"></ion-icon></button>
                                    </div>
                                </div>
                            </div>
                            <!-- Example row 3 -->
                            <div class="oh-sticky-table__tr">
                                <div class="oh-sticky-table__td"><input type="checkbox" class="oh-checkbox row-checkbox-reimbursement"></div>
                                <div class="oh-sticky-table__td">Suresh Patel</div>
                                <div class="oh-sticky-table__td">Delhi Trip</div>
                                <div class="oh-sticky-table__td">12,000</div>
                                <div class="oh-sticky-table__td">2024-07-15</div>
                                <div class="oh-sticky-table__td">
                                    <span class="oh-status" style="background: #22c55e; color: #fff; border-radius: 12px; padding: 4px 16px; font-size: 0.95em; font-weight: 500;">Success</span>
                                </div>
                                <div class="oh-sticky-table__td">
                                    <div class="oh-btn-group gap-2">
                                        <button class="oh-btn oh-btn--success oh-btn--small" title="Approve"><ion-icon name="checkmark-outline"></ion-icon></button>
                                        <button class="oh-btn oh-btn--danger oh-btn--small" title="Reject"><ion-icon name="close-outline"></ion-icon></button>
                                    </div>
                                </div>
                            </div>
                            <!-- Example row 4 -->
                            <div class="oh-sticky-table__tr">
                                <div class="oh-sticky-table__td"><input type="checkbox" class="oh-checkbox row-checkbox-reimbursement"></div>
                                <div class="oh-sticky-table__td">Meera Nair</div>
                                <div class="oh-sticky-table__td">Chennai Trip</div>
                                <div class="oh-sticky-table__td">4,200</div>
                                <div class="oh-sticky-table__td">2024-07-12</div>
                                <div class="oh-sticky-table__td">
                                    <span class="oh-status" style="background: #facc15; color: #222; border-radius: 12px; padding: 4px 16px; font-size: 0.95em; font-weight: 500;">Pending</span>
                                </div>
                                <div class="oh-sticky-table__td">
                                    <div class="oh-btn-group gap-2">
                                        <button class="oh-btn oh-btn--success oh-btn--small" title="Approve"><ion-icon name="checkmark-outline"></ion-icon></button>
                                        <button class="oh-btn oh-btn--danger oh-btn--small" title="Reject"><ion-icon name="close-outline"></ion-icon></button>
                                    </div>
                                </div>
                            </div>
                            <!-- Example row 5 -->
                            <div class="oh-sticky-table__tr">
                                <div class="oh-sticky-table__td"><input type="checkbox" class="oh-checkbox row-checkbox-reimbursement"></div>
                                <div class="oh-sticky-table__td">David Lee</div>
                                <div class="oh-sticky-table__td">Bangalore Trip</div>
                                <div class="oh-sticky-table__td">9,800</div>
                                <div class="oh-sticky-table__td">2024-07-10</div>
                                <div class="oh-sticky-table__td">
                                    <span class="oh-status" style="background: #ef4444; color: #fff; border-radius: 12px; padding: 4px 16px; font-size: 0.95em; font-weight: 500;">Rejected</span>
                                </div>
                                <div class="oh-sticky-table__td">
                                    <div class="oh-btn-group gap-2">
                                        <button class="oh-btn oh-btn--success oh-btn--small" title="Approve"><ion-icon name="checkmark-outline"></ion-icon></button>
                                        <button class="oh-btn oh-btn--danger oh-btn--small" title="Reject"><ion-icon name="close-outline"></ion-icon></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Reimbursement Modal -->
<div id="newReimbursementModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center; z-index: 1000;">
    <div style="background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #e0e0e0;">
            <h2 style="margin: 0; font-size: 24px; font-weight: 600; color: #333;">New Reimbursement Request</h2>
            <button onclick="closeReimbursementModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; display: flex; align-items: center; justify-content: center;">
                <ion-icon name="close-outline"></ion-icon>
            </button>
        </div>
        
        <!-- Body -->
        <div style="padding: 24px;">
            <form method="post" enctype="multipart/form-data">
                <!-- Row 1: Travel Request and Total Amount -->
                <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 14px;">Travel Request</label>
                        <select name="travel_request" required style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; background-color: white; color: #333;">
                            <option value="">Select Travel Request</option>
                            <option value="1">Mumbai Trip (15-18 Jun)</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 250px;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 14px;">Total Amount</label>
                        <input type="number" name="amount" required style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                    </div>
                </div>
                
                <!-- Expense Details Section -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 12px; font-weight: 500; color: #333; font-size: 14px;">Expense Details</label>
                    
                    <!-- Table Container -->
                    <div style="border: 1px solid #ddd; border-radius: 4px; overflow: hidden; margin-bottom: 12px;">
                        <!-- Table Header -->
                        <div style="background-color: #f8f9fa; display: flex; border-bottom: 1px solid #ddd;">
                            <div style="flex: 1; padding: 12px; font-weight: 600; color: #333; border-right: 1px solid #ddd;">Category</div>
                            <div style="flex: 1; padding: 12px; font-weight: 600; color: #333; border-right: 1px solid #ddd;">Date</div>
                            <div style="flex: 1; padding: 12px; font-weight: 600; color: #333; border-right: 1px solid #ddd;">Amount</div>
                            <div style="flex: 1; padding: 12px; font-weight: 600; color: #333;">Bill</div>
                        </div>
                        
                        <!-- Table Body -->
                        <div id="expenseRows">
                            <div style="display: flex; border-bottom: 1px solid #ddd;" class="expense-row">
                                <div style="flex: 1; padding: 8px; border-right: 1px solid #ddd;">
                                    <select name="category[]" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; background-color: white;">
                                        <option value="travel">Travel</option>
                                        <option value="accommodation">Accommodation</option>
                                        <option value="food">Food</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div style="flex: 1; padding: 8px; border-right: 1px solid #ddd;">
                                    <input type="date" name="expense_date[]" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                                </div>
                                <div style="flex: 1; padding: 8px; border-right: 1px solid #ddd;">
                                    <input type="number" name="expense_amount[]" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                                </div>
                                <div style="flex: 1; padding: 8px;">
                                    <input type="file" name="bill[]" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box; background-color: white;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add More Button -->
                    <button type="button" onclick="addExpenseRow()" style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; background-color: #f8f9fa; color: #666; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; cursor: pointer; transition: background-color 0.3s ease;" onmouseover="this.style.backgroundColor='#e9ecef'" onmouseout="this.style.backgroundColor='#f8f9fa'">
                        <ion-icon name="add-outline"></ion-icon>
                        Add More
                    </button>
                </div>
                
                <!-- Notes Section -->
                <div style="margin-bottom: 30px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 14px;">Notes</label>
                    <textarea name="notes" rows="3" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; resize: vertical; box-sizing: border-box; font-family: Arial, sans-serif;"></textarea>
                </div>
                
                <!-- Footer -->
                <div style="padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <button type="submit" style="width: 100%; padding: 12px 24px; background-color: #e74c3c; color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: 500; cursor: pointer; transition: background-color 0.3s ease;" onmouseover="this.style.backgroundColor='#c0392b'" onmouseout="this.style.backgroundColor='#e74c3c'">
                        Submit Reimbursement
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function addExpenseRow() {
        const expenseRows = document.getElementById('expenseRows');
        const newRow = document.createElement('div');
        newRow.style.cssText = 'display: flex; border-bottom: 1px solid #ddd;';
        newRow.className = 'expense-row';
        
        newRow.innerHTML = `
            <div style="flex: 1; padding: 8px; border-right: 1px solid #ddd;">
                <select name="category[]" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; background-color: white;">
                    <option value="travel">Travel</option>
                    <option value="accommodation">Accommodation</option>
                    <option value="food">Food</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div style="flex: 1; padding: 8px; border-right: 1px solid #ddd;">
                <input type="date" name="expense_date[]" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
            </div>
            <div style="flex: 1; padding: 8px; border-right: 1px solid #ddd;">
                <input type="number" name="expense_amount[]" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
            </div>
            <div style="flex: 1; padding: 8px; position: relative;">
                <input type="file" name="bill[]" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box; background-color: white;">
                <button type="button" onclick="removeExpenseRow(this)" style="position: absolute; top: 4px; right: 4px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">×</button>
            </div>
        `;
        
        expenseRows.appendChild(newRow);
    }
    
    function removeExpenseRow(button) {
        const row = button.closest('.expense-row');
        if (document.querySelectorAll('.expense-row').length > 1) {
            row.remove();
        }
    }

    function openReimbursementModal() {
        document.getElementById('newReimbursementModal').style.display = 'flex';
    }
    function closeReimbursementModal() {
        document.getElementById('newReimbursementModal').style.display = 'none';
    }

    // Live search for reimbursement table
    const reimbursementSearchInput = document.getElementById('reimbursement-search-input');
    if (reimbursementSearchInput) {
        reimbursementSearchInput.addEventListener('input', function() {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll('.oh-sticky-table__tbody .oh-sticky-table__tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        });
    }

    // Select all checkboxes functionality for reimbursement table
    const selectAllReimbursements = document.getElementById('select-all-reimbursements');
    if (selectAllReimbursements) {
        selectAllReimbursements.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.row-checkbox-reimbursement');
            checkboxes.forEach(cb => {
                cb.checked = selectAllReimbursements.checked;
            });
        });
    }
</script>

<!-- View Details Modal -->
<div class="oh-modal" id="viewDetailsModal" role="dialog" aria-labelledby="viewDetailsModalLabel" aria-hidden="true">
    <div class="oh-modal__dialog">
        <div class="oh-modal__dialog-header">
            <h2 class="oh-modal__dialog-title" id="viewDetailsModalLabel">
                {% trans "Reimbursement Details" %}
            </h2>
            <button class="oh-modal__close" aria-label="Close">
                <ion-icon name="close-outline"></ion-icon>
            </button>
        </div>
        <div class="oh-modal__dialog-body" id="viewDetailsForm">
            <!-- Will be populated dynamically -->
        </div>
    </div>
</div>

{% endblock %} 