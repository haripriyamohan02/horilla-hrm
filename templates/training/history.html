{% extends 'index.html' %}
{% load static %}
{% load i18n %}

{% block content %}
<div class="oh-card" style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); margin: 3px; overflow: hidden;">
    <div class="oh-card__header" style="padding: 20px 18px; border-bottom: 1px solid #e5e7eb; background: #f9fafb; display: flex; justify-content: space-between; align-items: center;">
        <h4 class="oh-card__title" style="font-size: 18px; font-weight: 600; color: #111827; margin: 0;">Training History & Records</h4>
        <div class="oh-card__actions">
            <button id="exportBtn" class="oh-btn oh-btn--outline oh-btn--sm" style="background: #ffffff; border: 1px solid #d1d5db; color: #374151; padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='#ffffff'">Export Report</button>
        </div>
    </div>
    <div class="oh-card__body" style="padding: 7px;">
        <!-- Summary Stats -->
        <div id="summaryGrid" class="oh-summary-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 16px;">
            <div class="oh-summary-item" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 16px; text-align: center;">
                <span class="oh-summary-item__label" style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 8px; font-weight: 500;">Total Completed</span>
                <span id="totalCompleted" class="oh-summary-item__value" style="font-size: 18px; font-weight: 700; color: #111827;">0</span>
            </div>
            <div class="oh-summary-item" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 16px; text-align: center;">
                <span class="oh-summary-item__label" style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 8px; font-weight: 500;">Total Hours</span>
                <span id="totalHours" class="oh-summary-item__value" style="font-size: 18px; font-weight: 700; color: #111827;">0</span>
            </div>
            <div class="oh-summary-item" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 16px; text-align: center;">
                <span class="oh-summary-item__label" style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 8px; font-weight: 500;">Certificates Issued</span>
                <span id="totalCertificates" class="oh-summary-item__value" style="font-size: 18px; font-weight: 700; color: #111827;">0</span>
            </div>
            <div class="oh-summary-item" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 16px; text-align: center;">
                <span class="oh-summary-item__label" style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 8px; font-weight: 500;">Average Score</span>
                <span id="averageScore" class="oh-summary-item__value" style="font-size: 18px; font-weight: 700; color: #111827;">0%</span>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="oh-filter-section" style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 20px; margin-bottom: 18px; display: flex; gap: 20px; flex-wrap: wrap;">
            <div class="oh-filter-group" style="flex: 1; min-width: 200px;">
                <label class="oh-label" style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">Employee</label>
                <select id="employeeFilter" class="oh-select oh-select--sm" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; color: #111827; background: #ffffff;">
                    <option value="">All Employees</option>
                </select>
            </div>
            <div class="oh-filter-group" style="flex: 1; min-width: 200px;">
                <label class="oh-label" style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">Course Category</label>
                <select id="categoryFilter" class="oh-select oh-select--sm" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; color: #111827; background: #ffffff;">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="oh-filter-group" style="flex: 1; min-width: 150px;">
                <label class="oh-label" style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">Year</label>
                <select id="yearFilter" class="oh-select oh-select--sm" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; color: #111827; background: #ffffff;">
                    <option value="">All Years</option>
                </select>
            </div>
            <div class="oh-filter-group" style="flex: 1; min-width: 200px;">
                <label class="oh-label" style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px;">Search</label>
                <input id="searchFilter" type="text" placeholder="Search courses..." class="oh-input" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; color: #111827; background: #ffffff;">
            </div>
        </div>

        <!-- Training History Table -->
        <div style="overflow-x: auto; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; max-height: 500px;">
            <table id="trainingTable" class="oh-table" style="width: 100%; border-collapse: collapse; font-size: 14px; min-width: 800px;">
                <thead style="position: sticky; top: 0; z-index: 10;">
                    <tr style="background: #f9fafb;">
                        <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Employee</th>
                        <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Course Name</th>
                        <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Category</th>
                        <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Completion Date</th>
                        <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Duration</th>
                        <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Score</th>
                        <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Certificate</th>
                        <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Expiry Date</th>
                    </tr>
                </thead>
                <tbody id="trainingTableBody">
                </tbody>
            </table>
        </div>
        
        <div id="noResults" style="display: none; text-align: center; padding: 40px; color: #6b7280;">
            <p style="font-size: 16px; margin: 0;">No training records found matching your criteria.</p>
        </div>
    </div>
</div>

<script>
// Sample training data
const trainingData = [
    {
        employee: "John Smith",
        department: "Engineering",
        course: "Workplace Safety Training",
        category: "Safety",
        completionDate: "2024-01-15",
        duration: "8 hours",
        durationHours: 8,
        score: 92,
        certificate: true,
        expiryDate: "2027-01-15"
    },
    {
        employee: "Sarah Johnson",
        department: "Management",
        course: "Leadership Development Program",
        category: "Leadership",
        completionDate: "2024-01-10",
        duration: "40 hours",
        durationHours: 40,
        score: 88,
        certificate: true,
        expiryDate: null
    },
    {
        employee: "Mike Davis",
        department: "IT",
        course: "Data Privacy & Security",
        category: "Compliance",
        completionDate: "2023-12-20",
        duration: "12 hours",
        durationHours: 12,
        score: 95,
        certificate: true,
        expiryDate: "2026-12-20"
    },
    {
        employee: "Emily Chen",
        department: "HR",
        course: "Advanced Excel Training",
        category: "Technical",
        completionDate: "2024-02-05",
        duration: "16 hours",
        durationHours: 16,
        score: 91,
        certificate: true,
        expiryDate: null
    },
    {
        employee: "David Wilson",
        department: "Sales",
        course: "Customer Service Excellence",
        category: "Technical",
        completionDate: "2024-01-20",
        duration: "6 hours",
        durationHours: 6,
        score: 85,
        certificate: true,
        expiryDate: "2026-01-20"
    }
];

let filteredData = [...trainingData];

// Initialize the application
function init() {
    populateFilters();
    renderTable(filteredData);
    updateSummaryStats(filteredData);
    setupEventListeners();
}

// Populate filter dropdowns
function populateFilters() {
    const employees = [...new Set(trainingData.map(item => item.employee))].sort();
    const categories = [...new Set(trainingData.map(item => item.category))].sort();
    const years = [...new Set(trainingData.map(item => new Date(item.completionDate).getFullYear()))].sort((a, b) => b - a);

    populateSelect('employeeFilter', employees);
    populateSelect('categoryFilter', categories);
    populateSelect('yearFilter', years);
}

function populateSelect(selectId, options) {
    const select = document.getElementById(selectId);
    options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        select.appendChild(optionElement);
    });
}

// Render the table
function renderTable(data) {
    const tbody = document.getElementById('trainingTableBody');
    const noResults = document.getElementById('noResults');
    
    if (data.length === 0) {
        tbody.innerHTML = '';
        noResults.style.display = 'block';
        return;
    }
    
    noResults.style.display = 'none';
    
    tbody.innerHTML = data.map(item => `
        <tr style="border-bottom: 1px solid #f3f4f6;">
            <td style="padding: 12px 16px;">
                <div class="oh-employee-info">
                    <strong style="display: block; color: #111827; font-weight: 600; font-size: 14px;">${item.employee}</strong>
                    <small style="color: #6b7280; font-size: 12px;">${item.department}</small>
                </div>
            </td>
            <td style="padding: 12px 16px; color: #111827;">${item.course}</td>
            <td style="padding: 12px 16px;">
                <span class="oh-category-tag ${getCategoryClass(item.category)}" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">${item.category}</span>
            </td>
            <td style="padding: 12px 16px; color: #6b7280;">${item.completionDate}</td>
            <td style="padding: 12px 16px; color: #6b7280;">${item.duration}</td>
            <td style="padding: 12px 16px;">
                <div class="oh-score" style="display: flex; align-items: center; gap: 8px;">
                    <span class="oh-score__value" style="font-weight: 600; color: #111827;">${item.score}%</span>
                    <span class="oh-score__grade ${getGradeClass(item.score)}" style="padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600;">${getGrade(item.score)}</span>
                </div>
            </td>
            <td style="padding: 12px 16px;">
                ${item.certificate ? `
                    <button class="oh-btn oh-btn--link oh-btn--xs" style="background: none; border: none; color: #3b82f6; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; padding: 4px 0;" onmouseover="this.style.color='#1d4ed8'" onmouseout="this.style.color='#3b82f6'">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Download
                    </button>
                ` : '<span style="color: #6b7280;">N/A</span>'}
            </td>
            <td style="padding: 12px 16px; color: #6b7280;">${item.expiryDate || 'No Expiry'}</td>
        </tr>
    `).join('');
}

// Helper functions for styling
function getCategoryClass(category) {
    const classes = {
        'Safety': 'background: #fef2f2; color: #dc2626;',
        'Leadership': 'background: #ede9fe; color: #7c3aed;',
        'Compliance': 'background: #fef3c7; color: #d97706;',
        'Technical': 'background: #ecfdf5; color: #059669;'
    };
    return `style="${classes[category] || 'background: #f3f4f6; color: #374151;'}"`;
}

function getGradeClass(score) {
    if (score >= 95) return 'style="background: #dcfce7; color: #166534;"';
    if (score >= 90) return 'style="background: #dcfce7; color: #166534;"';
    if (score >= 85) return 'style="background: #dbeafe; color: #1e40af;"';
    if (score >= 80) return 'style="background: #fef3c7; color: #d97706;"';
    return 'style="background: #fef2f2; color: #dc2626;"';
}

function getGrade(score) {
    if (score >= 97) return 'A+';
    if (score >= 93) return 'A';
    if (score >= 90) return 'A-';
    if (score >= 87) return 'B+';
    if (score >= 83) return 'B';
    if (score >= 80) return 'B-';
    if (score >= 77) return 'C+';
    if (score >= 73) return 'C';
    return 'C-';
}

// Update summary statistics
function updateSummaryStats(data) {
    const totalCompleted = data.length;
    const totalHours = data.reduce((sum, item) => sum + item.durationHours, 0);
    const totalCertificates = data.filter(item => item.certificate).length;
    const averageScore = data.length > 0 ? (data.reduce((sum, item) => sum + item.score, 0) / data.length).toFixed(1) : 0;

    document.getElementById('totalCompleted').textContent = totalCompleted;
    document.getElementById('totalHours').textContent = totalHours.toLocaleString();
    document.getElementById('totalCertificates').textContent = totalCertificates;
    document.getElementById('averageScore').textContent = averageScore + '%';
}

// Apply filters
function applyFilters() {
    const employeeFilter = document.getElementById('employeeFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const yearFilter = document.getElementById('yearFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

    filteredData = trainingData.filter(item => {
        const employeeMatch = !employeeFilter || item.employee === employeeFilter;
        const categoryMatch = !categoryFilter || item.category === categoryFilter;
        const yearMatch = !yearFilter || new Date(item.completionDate).getFullYear().toString() === yearFilter;
        const searchMatch = !searchFilter || 
            item.employee.toLowerCase().includes(searchFilter) ||
            item.course.toLowerCase().includes(searchFilter) ||
            item.category.toLowerCase().includes(searchFilter);

        return employeeMatch && categoryMatch && yearMatch && searchMatch;
    });

    renderTable(filteredData);
    updateSummaryStats(filteredData);
}

// Setup event listeners
function setupEventListeners() {
    document.getElementById('employeeFilter').addEventListener('change', applyFilters);
    document.getElementById('categoryFilter').addEventListener('change', applyFilters);
    document.getElementById('yearFilter').addEventListener('change', applyFilters);
    document.getElementById('searchFilter').addEventListener('input', applyFilters);

    // Export functionality
    document.getElementById('exportBtn').addEventListener('click', function() {
        const table = document.getElementById('trainingTable');
        let csv = [];
        
        // Get headers
        const headers = Array.from(table.querySelectorAll('thead th')).map(th => 
            `"${th.textContent.trim()}"`
        );
        csv.push(headers.join(','));
        
        // Get data rows
        filteredData.forEach(item => {
            const row = [
                `"${item.employee}"`,
                `"${item.course}"`,
                `"${item.category}"`,
                `"${item.completionDate}"`,
                `"${item.duration}"`,
                `"${item.score}%"`,
                `"${item.certificate ? 'Available' : 'N/A'}"`,
                `"${item.expiryDate || 'No Expiry'}"`
            ];
            csv.push(row.join(','));
        });

        const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "training_history_report.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>

<script>
document.getElementById("exportBtn").addEventListener("click", function () {
    const table = document.getElementById("trainingTable");
    let csv = [];
    for (let row of table.rows) {
        let rowData = [];
        for (let cell of row.cells) {
            let text = cell.innerText.replace(/(\r\n|\n|\r)/gm, "").replace(/,/g, "");
            rowData.push('"' + text + '"');
        }
        csv.push(rowData.join(","));
    }
    const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "training_history_report.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});
</script>

{% endblock %}
