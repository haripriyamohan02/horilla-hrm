{% extends 'index.html' %}
{% load static %}
{% load i18n %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training History & Records</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8fafc;
            height: 90vh;
            overflow: hidden;
        }
        
        .main-container {
            height: 94vh;
            display: flex;
            flex-direction: column;
            padding: 3px;
            gap: 10px;
        }
        
        .oh-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .oh-card__header {
            padding: 15px 18px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .oh-card__title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }
        
        .oh-btn {
            background: #ffffff;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .oh-btn:hover {
            background: #f9fafb;
        }
        
        .oh-card__body {
            padding: 3px;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .oh-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        
        .oh-summary-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 16px;
            text-align: center;
        }
        
        .oh-summary-item__label {
            display: block;
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .oh-summary-item__value {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
        }
        
        .oh-filter-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        
        .oh-filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .oh-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }
        
        .oh-select, .oh-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            color: #111827;
            background: #ffffff;
        }
        
        .table-container {
            flex: 1;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 300px;
            max-height: 500px;
        }
        
        .table-scroll {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            position: relative;
        }
        
        .oh-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            min-width: 800px;
        }
        
        .oh-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f9fafb;
        }
        
        .oh-table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        
        .oh-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .oh-employee-info strong {
            display: block;
            color: #111827;
            font-weight: 600;
            font-size: 14px;
        }
        
        .oh-employee-info small {
            color: #6b7280;
            font-size: 12px;
        }
        
        .oh-category-tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .oh-score {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .oh-score__value {
            font-weight: 600;
            color: #111827;
        }
        
        .oh-score__grade {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .oh-btn--link {
            background: none;
            border: none;
            color: #3b82f6;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 0;
        }
        
        .oh-btn--link:hover {
            color: #1d4ed8;
        }
        
        .no-results-row {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
            font-size: 16px;
        }
        
        .no-results-cell {
            border: none !important;
            vertical-align: middle;
        }
    </style>
</head>
<body>
  <div class="main-container">
    <div class="oh-card">
      <div class="oh-card__header">
        <h4 class="oh-card__title">Training History & Records</h4>
        <div class="oh-card__actions">
          <button id="exportBtn" class="oh-btn">Export Report</button>
        </div>
      </div>
      <div class="oh-card__body">
        <!-- Summary Stats -->
        <div id="summaryGrid" class="oh-summary-grid">
          <div class="oh-summary-item">
            <span class="oh-summary-item__label">Total Completed</span>
            <span id="totalCompleted" class="oh-summary-item__value">0</span>
          </div>
          <div class="oh-summary-item">
            <span class="oh-summary-item__label">Total Hours</span>
            <span id="totalHours" class="oh-summary-item__value">0</span>
          </div>
          <div class="oh-summary-item">
            <span class="oh-summary-item__label">Certificates Issued</span>
            <span id="totalCertificates" class="oh-summary-item__value">0</span>
          </div>
          <div class="oh-summary-item">
            <span class="oh-summary-item__label">Average Score</span>
            <span id="averageScore" class="oh-summary-item__value">0%</span>
          </div>
          <div class="oh-summary-item">
            <span class="oh-summary-item__label">Expired Certificates</span>
            <span id="expiredCertificates" class="oh-summary-item__value">0</span>
          </div>
        </div>

        <!-- Filter Section -->
        <div class="oh-filter-section">
          <div class="oh-filter-group">
            <label class="oh-label">Employee</label>
            <select id="employeeFilter" class="oh-select">
              <option value="">All Employees</option>
            </select>
          </div>
          <div class="oh-filter-group">
            <label class="oh-label">Course Category</label>
            <select id="categoryFilter" class="oh-select">
              <option value="">All Categories</option>
            </select>
          </div>
          <div class="oh-filter-group" style="min-width: 150px;">
            <label class="oh-label">Year</label>
            <select id="yearFilter" class="oh-select">
              <option value="">All Years</option>
            </select>
          </div>
          <div class="oh-filter-group">
            <label class="oh-label">Search</label>
            <input id="searchFilter" type="text" placeholder="Search courses..." class="oh-input">
          </div>
        </div>

        <!-- Training History Table -->
        <div class="table-container">
          <div class="table-scroll">
            <table id="trainingTable" class="oh-table">
              <thead>
                <tr>
                  <th>Employee</th>
                  <th>Course Name</th>
                  <th>Category</th>
                  <th>Completion Date</th>
                  <th>Duration</th>
                  <th>Score</th>
                  <th>Certificate</th>
                  <th>Expiry Date</th>
                </tr>
              </thead>
              <tbody id="trainingTableBody">
                <!-- Data will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const trainingData = [
      {
        employee: "Aarav", department: "HR", course: "POSH Compliance Training", category: "Compliance",
        completionDate: "2024-03-10", duration: "2 hours", durationHours: 2, score: 94, certificate: true, expiryDate: "2024-05-01"
      },
      {
        employee: "Priya", department: "Finance", course: "GST & Tax Regulation 2024", category: "Finance",
        completionDate: "2024-02-18", duration: "6 hours", durationHours: 6, score: 88, certificate: true, expiryDate: "2026-02-18"
      },
      {
        employee: "Rohit", department: "IT", course: "Cybersecurity Awareness", category: "Technical",
        completionDate: "2024-01-25", duration: "3 hours", durationHours: 3, score: 97, certificate: true, expiryDate: "2026-01-25"
      },
      {
        employee: "Neha", department: "Admin", course: "Office Procedures & Document Handling", category: "Operations",
        completionDate: "2024-04-12", duration: "4 hours", durationHours: 4, score: 90, certificate: true, expiryDate: "2027-04-12"
      },
      {
        employee: "Amit", department: "Payroll", course: "PF, ESI & Payroll Compliance", category: "Compliance",
        completionDate: "2024-02-28", duration: "5 hours", durationHours: 5, score: 85, certificate: true, expiryDate: "2026-02-28"
      },
      {
        employee: "Sneha", department: "HR", course: "Recruitment & Selection Best Practices", category: "HR",
        completionDate: "2023-12-15", duration: "3 hours", durationHours: 3, score: 91, certificate: true, expiryDate: "2024-01-01"
      },
      {
        employee: "Karan", department: "IT", course: "e-HRMS Software Training", category: "Technical",
        completionDate: "2024-03-01", duration: "8 hours", durationHours: 8, score: 93, certificate: true, expiryDate: null
      },
      {
        employee: "Divya", department: "Legal", course: "Labor Law Reforms 2024", category: "Legal",
        completionDate: "2024-01-30", duration: "6 hours", durationHours: 6, score: 89, certificate: true, expiryDate: "2026-01-30"
      },
      {
        employee: "Siddharth", department: "HR", course: "Employee Grievance Handling", category: "HR",
        completionDate: "2024-05-10", duration: "3 hours", durationHours: 3, score: 92, certificate: true, expiryDate: "2026-05-10"
      },
      {
        employee: "Anjali", department: "Finance", course: "Payroll Automation with Excel", category: "Technical",
        completionDate: "2024-03-15", duration: "4 hours", durationHours: 4, score: 95, certificate: true, expiryDate: null
      }
    ];

    let filteredData = [...trainingData];

    function init() {
      populateFilters();
      renderTable(filteredData);
      updateSummaryStats(filteredData);
      setupEventListeners();
    }

    function populateFilters() {
      const employees = [...new Set(trainingData.map(item => item.employee))].sort();
      const categories = [...new Set(trainingData.map(item => item.category))].sort();
      const years = [...new Set(trainingData.map(item => new Date(item.completionDate).getFullYear()))].sort((a, b) => b - a);

      populateSelect('employeeFilter', employees);
      populateSelect('categoryFilter', categories);
      populateSelect('yearFilter', years);
    }

    function populateSelect(id, options) {
      const select = document.getElementById(id);
      options.forEach(option => {
        const el = document.createElement('option');
        el.value = option;
        el.textContent = option;
        select.appendChild(el);
      });
    }

    function renderTable(data) {
      const tbody = document.getElementById('trainingTableBody');
      if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="no-results-cell">No training records found matching your criteria.</td></tr>`;
        return;
      }

      tbody.innerHTML = data.map(item => `
        <tr>
                    <td>
                        <div class="oh-employee-info">
                            <strong>${item.employee}</strong>
                            <small>${item.department}</small>
                        </div>
                    </td>
                    <td style="color: #111827;">${item.course}</td>
                    <td>
                        <span class="oh-category-tag" style="${getCategoryStyle(item.category)}">${item.category}</span>
                    </td>
                    <td style="color: #6b7280;">${item.completionDate}</td>
                    <td style="color: #6b7280;">${item.duration}</td>
                    <td>
                        <div class="oh-score">
                            <span class="oh-score__value">${item.score}%</span>
                            <span class="oh-score__grade" style="${getGradeStyle(item.score)}">${getGrade(item.score)}</span>
                        </div>
                    </td>
                    <td>
                        ${item.certificate ? `
                            <button class="oh-btn--link">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Download
                            </button>
                        ` : '<span style="color: #6b7280;">N/A</span>'}
                    </td>
                    <td style="color: #6b7280;">${item.expiryDate || 'No Expiry'}</td>
        </tr>
      `).join('');
    }

        // Helper functions for styling
        function getCategoryStyle(category) {
            const styles = {
                'Safety': 'background: #fef2f2; color: #dc2626;',
                'Leadership': 'background: #ede9fe; color: #7c3aed;',
                'Compliance': 'background: #fef3c7; color: #d97706;',
                'Technical': 'background: #ecfdf5; color: #059669;'
            };
            return styles[category] || 'background: #f3f4f6; color: #374151;';
        }

        function getGradeStyle(score) {
            if (score >= 95) return 'background: #dcfce7; color: #166534;';
            if (score >= 90) return 'background: #dcfce7; color: #166534;';
            if (score >= 85) return 'background: #dbeafe; color: #1e40af;';
            if (score >= 80) return 'background: #fef3c7; color: #d97706;';
            return 'background: #fef2f2; color: #dc2626;';
        }

    function getGrade(score) {
      if (score >= 97) return 'A+';
      if (score >= 93) return 'A';
      if (score >= 90) return 'A-';
      if (score >= 87) return 'B+';
      if (score >= 83) return 'B';
      if (score >= 80) return 'B-';
            if (score >= 77) return 'C+';
            if (score >= 73) return 'C';
            return 'C-';
    }

    function updateSummaryStats(data) {
      const totalCompleted = data.length;
      const totalHours = data.reduce((sum, item) => sum + item.durationHours, 0);
      const totalCertificates = data.filter(item => item.certificate).length;
      const averageScore = totalCompleted > 0 ? (data.reduce((sum, item) => sum + item.score, 0) / totalCompleted).toFixed(1) : 0;
      const expiredCertificates = data.filter(item =>
        item.certificate && item.expiryDate && new Date(item.expiryDate) < new Date()
      ).length;

      document.getElementById('totalCompleted').textContent = totalCompleted;
      document.getElementById('totalHours').textContent = totalHours;
      document.getElementById('totalCertificates').textContent = totalCertificates;
      document.getElementById('averageScore').textContent = averageScore + '%';
      document.getElementById('expiredCertificates').textContent = expiredCertificates;
    }

    function applyFilters() {
      const employee = document.getElementById('employeeFilter').value;
      const category = document.getElementById('categoryFilter').value;
      const year = document.getElementById('yearFilter').value;
      const search = document.getElementById('searchFilter').value.toLowerCase();

      filteredData = trainingData.filter(item => {
        const matchesEmployee = !employee || item.employee === employee;
        const matchesCategory = !category || item.category === category;
        const matchesYear = !year || new Date(item.completionDate).getFullYear().toString() === year;
        const matchesSearch = !search ||
          item.employee.toLowerCase().includes(search) ||
          item.course.toLowerCase().includes(search) ||
          item.category.toLowerCase().includes(search);

        return matchesEmployee && matchesCategory && matchesYear && matchesSearch;
      });

      renderTable(filteredData);
      updateSummaryStats(filteredData);
    }

    function setupEventListeners() {
      document.getElementById('employeeFilter').addEventListener('change', applyFilters);
      document.getElementById('categoryFilter').addEventListener('change', applyFilters);
      document.getElementById('yearFilter').addEventListener('change', applyFilters);
      document.getElementById('searchFilter').addEventListener('input', applyFilters);

      document.getElementById('exportBtn').addEventListener('click', function () {
        const csv = [];
        const headers = ["Employee", "Course Name", "Category", "Completion Date", "Duration", "Score", "Certificate", "Expiry Date"];
        csv.push(headers.join(","));

        filteredData.forEach(item => {
          const row = [
            item.employee, item.course, item.category, item.completionDate,
            item.duration, item.score + "%", item.certificate ? 'Available' : 'N/A',
            item.expiryDate || 'No Expiry'
          ];
          csv.push(row.map(v => `"${v}"`).join(","));
        });

        const csvBlob = new Blob([csv.join("\n")], { type: "text/csv" });
        const url = URL.createObjectURL(csvBlob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "training_history_report.csv";
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>

{% endblock %}