{% extends 'index.html' %}
{% load static %}
{% load i18n %}

{% block content %}
<style>
    /* Ensure select and input fields look identical and have the same focus border */
    .oh-input,
    select.oh-input {
        border: 1.5px solid #ced4da !important;
        border-radius: 4px !important;
        font-size: 13px !important;
        padding: 8px 10px !important;
        background: #fff !important;
        transition: border-color 0.2s, box-shadow 0.2s;
        box-shadow: none !important;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
    }

    .oh-input:focus,
    select.oh-input:focus {
        border: 1.5px solid #1976d2 !important;
        outline: none !important;
        box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.10) !important;
    }

    /* Optional: Add a custom arrow for select to match input style */
    select.oh-input {
        background-image: url('data:image/svg+xml;utf8,<svg fill="%23999" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 20px 20px;
        padding-right: 32px !important;
    }

    /* Make select and input fields look the same, especially on focus */
    .oh-input,
    .oh-input:focus,
    select.oh-input,
    select.oh-input:focus {
        border: 1.5px solid #aeaeae;
        border-radius: 4px;
        font-size: 13px;
        padding: 8px 10px;
        background: #fff;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .oh-input:focus,
    select.oh-input:focus {
        border: 1.5px solid #1976d2 !important; /* Your primary color */
        outline: none !important;
        box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.10); /* Optional subtle glow */
    }

    select.oh-input {
        appearance: auto;
        background-color: #fff;
        cursor: pointer;
        border: 1px solid #ced4da;
    }

    select.oh-input:hover {
        border-color: #80bdff;
    }

    #to-container select.oh-input:focus {
        border: 1.5px solid #1976d2 !important;
        outline: none !important;
        box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.15);
    }
</style>

<div class="oh-wrapper m-0" style="max-width: 100%;">
    <div class="oh-content">
        <div class="oh-row">
            <div class="oh-card bg-transparent">
                <!-- Updated header with better alignment matching the second image -->
                <div class="d-flex align-items-center justify-content-between mb-3" style="gap: 16px;">
                    <h4 class="oh-card__title mb-0" style="font-weight: 600; white-space: nowrap; min-width: fit-content;">Transfer Requests</h4>
                    
                    <div class="d-flex align-items-center" style="gap: 12px; flex: 1; justify-content: flex-end;">
                        <!-- Search Input -->
                        <div class="input-group" style="max-width: 280px;">
                            <!-- <span class="input-group-text bg-white border-end-0" style="border-radius: 4px 0 0 4px; border: 1.5px solid #ced4da; border-right: none; padding: 8px 12px;">
                                <ion-icon name="search-outline" style="font-size: 16px; color: #666;"></ion-icon>
                            </span> -->
                            <input type="text" class="form-control oh-input border-start-0" placeholder="Search" style="border-radius: 0 4px 4px 0; border: 1.5px solid #ced4da; border-left: none;">
                        </div>
                        
                        <!-- Filter Button -->
                        <button class="oh-btn oh-btn--secondary d-flex align-items-center" style="background: #f5f5f5; color: #222; border: 1.5px solid #e0e0e0; font-weight: 500; white-space: nowrap;">
                            <ion-icon name="filter-outline" style="margin-right: 6px; font-size: 16px;"></ion-icon> Filter
                        </button>
                        
                        <!-- Group By Button -->
                        <button class="oh-btn oh-btn--secondary d-flex align-items-center" style="background: #f5f5f5; color: #222; border: 1.5px solid #e0e0e0; font-weight: 500; white-space: nowrap;">
                            <ion-icon name="bar-chart-outline" style="margin-right: 6px; font-size: 16px;"></ion-icon> Group By
                        </button>
                        
                        <!-- Create Button -->
                        <button class="oh-btn oh-btn--primary" style="background-color: #ff3b38; border-color: #ff3b38; font-weight: 600; white-space: nowrap; min-width: fit-content;" onclick="toggleModal('createTransferRequestModal')">
                            <ion-icon name="add-outline" style="margin-right: 6px; font-size: 16px;"></ion-icon>
                            Create
                        </button>
                    </div>
                </div>
                <div class="oh-card__body">
                    <table class="oh-table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Current Department</th>
                                <th>Requested Department</th>
                                <th>Requested Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="request-table-body">
                            <!-- Table content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="oh-modal" id="createTransferRequestModal">
    <div class="oh-modal__dialog" style="max-width: 950px; width: 99%; background: white; border-radius: 14px; box-shadow: 0 8px 40px rgba(0,0,0,0.20); max-height: 96vh; overflow-y: auto; padding: 18px 0;">
        <div class="oh-modal__dialog-header" style="padding: 15px 20px; border-bottom: 1px solid #e9ecef;">
            <h5 class="oh-modal__dialog-title" style="margin: 0; font-size: 16px; font-weight: 600; color: #333;">New Transfer Request</h5>
            <button class="oh-modal__close" onclick="toggleModal('createTransferRequestModal')" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666; position: absolute; top: 4px; right: 15px;">&times;</button>
        </div>
        <div class="oh-modal__dialog-body" style="padding: 15px 20px;">
            <form id="create-transfer-request-form">
                <div class="row" style="display: flex; margin: 0 -8px; margin-bottom: 15px;">
                    <div class="col-md-6" style="flex: 0 0 50%; padding: 0 8px;">
                        <div class="oh-form-group" style="margin-bottom: 0;">
                            <label for="employee-request" class="oh-label" style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 13px;">Employee *</label>
                            <input type="text" id="employee-request" class="oh-input" placeholder="Enter employee name" style="width: 100%; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                        </div>
                    </div>
                    <div class="col-md-6" style="flex: 0 0 50%; padding: 0 8px;">
                        <div class="oh-form-group" style="margin-bottom: 0;">
                            <label for="email-request" class="oh-label" style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 13px;">Email *</label>
                            <input type="email" id="email-request" class="oh-input" placeholder="Enter email address" style="width: 100%; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                        </div>
                    </div>
                </div>
                <div class="row" style="display: flex; margin: 0 -8px; margin-bottom: 15px;">
                    <div class="col-md-6" style="flex: 0 0 50%; padding: 0 8px;">
                        <div class="oh-form-group" style="margin-bottom: 0;">
                            <label for="transfer_type_request" class="oh-label" style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 13px;">Transfer Type *</label>
                            <select id="transfer_type_request" class="oh-input" style="width: 100%; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                                <option value="">Select transfer type</option>
                                <option value="DEPARTMENT">Department</option>
                                <option value="POSITION">Position</option>
                                <option value="LOCATION">Location</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6" style="flex: 0 0 50%; padding: 0 8px;">
                        <div class="oh-form-group" style="margin-bottom: 0;">
                            <label for="from-request" class="oh-label" style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 13px;">From *</label>
                            <input type="text" id="from-request" class="oh-input" placeholder="Current department/position/location" style="width: 100%; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                        </div>
                    </div>
                </div>
                <div class="row" style="display: flex; margin: 0 -8px; margin-bottom: 15px;">
                    <div class="col-md-6" style="flex: 0 0 50%; padding: 0 8px;">
                        <div class="oh-form-group" style="margin-bottom: 0;">
                            <label for="to-request" class="oh-label" style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 13px;">To *</label>
                            <div id="to-container">
                                <!-- This will be populated by JavaScript based on transfer type -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6" style="flex: 0 0 50%; padding: 0 8px;">
                        <div class="oh-form-group" style="margin-bottom: 0;">
                            <label for="request_date_request" class="oh-label" style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 13px;">Request Date *</label>
                            <input type="date" id="request_date_request" class="oh-input" style="width: 100%; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                        </div>
                    </div>
                </div>
                <div class="oh-form-group" style="margin-bottom: 0;">
                    <label for="reason-request" class="oh-label" style="display: block; margin-bottom: 6px; font-weight: 500; color: #333; font-size: 13px;">Reason for Transfer</label>
                    <textarea id="reason-request" class="oh-input" rows="2" placeholder="Enter reason for transfer (optional)" style="width: 100%; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px; resize: vertical; min-height: 60px;"></textarea>
                </div>
            </form>
        </div>
        <div class="oh-modal__dialog-footer" style="padding: 12px 20px; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end; gap: 8px;">
            <!-- <button class="oh-btn oh-btn--secondary" onclick="toggleModal('createTransferRequestModal')" style="padding: 6px 12px; font-size: 13px;">Cancel</button> -->
            <button class="oh-btn oh-btn--primary" id="save-transfer-request-btn" style="padding: 6px 12px; font-size: 13px; background-color: #ff3b38;">Save Transfer</button>
        </div>
    </div>
</div>

<script>
    function getTransfers() {
        // Read from localStorage, or initialize with default if not present
        let transfers = JSON.parse(localStorage.getItem('horillaTransfers') || 'null');
        if (!transfers) {
            transfers = [
                {
                    employee: "Ritha",
                    email: "ritha.s@tringapps.com",
                    from: "Engineering",
                    to: "Product",
                    request_date: "2025-06-15",
                    status: "PENDING"
                },
                {
                    employee: "John Doe",
                    email: "john.doe@example.com",
                    from: "Marketing",
                    to: "Sales",
                    request_date: "2024-07-01",
                    status: "APPROVED"
                },
                {
                    employee: "Jane Smith",
                    email: "jane.smith@example.com",
                    from: "Sales",
                    to: "Marketing",
                    request_date: "2024-07-05",
                    status: "REJECTED"
                },
                {
                    employee: "Peter Jones",
                    email: "peter.jones@example.com",
                    from: "Engineering",
                    to: "Product",
                    request_date: "2024-07-10",
                    status: "PENDING"
                }
            ];
            localStorage.setItem('horillaTransfers', JSON.stringify(transfers));
        }
        return transfers;
    }

    function addTransfer(newTransfer) {
        const transfers = getTransfers();
        transfers.unshift(newTransfer); // Add to top
        localStorage.setItem('horillaTransfers', JSON.stringify(transfers));
    }

    function renderRequestsTable() {
        const transfers = getTransfers();
        const tableBody = document.getElementById('request-table-body');
        if (!tableBody) return;
        
        tableBody.innerHTML = '';

        transfers.forEach(t => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>
                    <div class="oh-profile">
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(t.employee)}&background=random" class="oh-profile__image mr-2 ml-2" />
                        <div class="oh-profile__name">${t.employee}<br/><small>${t.email}</small></div>
                    </div>
                </td>
                <td>${t.from}</td>
                <td>${t.to}</td>
                <td>${t.request_date}</td>
                <td>
                    <span class="oh-status oh-status--${t.status.toLowerCase() === 'pending' ? 'warning' : 
                                                      t.status.toLowerCase() === 'approved' ? 'success' : 'danger'}">
                        ${t.status}
                    </span>
                </td>
            `;
        });
    }

    function initializePostings() {
        console.log('Initializing postings');
        if (!localStorage.getItem('horillaPostings')) {
            const initialPostings = [
                { id: 1, position_name: 'Frontend Developer', department: 'Engineering', vacancy: 5 },
                { id: 2, position_name: 'Marketing Manager', department: 'Marketing', vacancy: 3 },
                { id: 3, position_name: 'Sales Executive', department: 'Sales', vacancy: 2 },
                { id: 4, position_name: 'Product Manager', department: 'Product', vacancy: 4 }
            ];
            localStorage.setItem('horillaPostings', JSON.stringify(initialPostings));
        }
    }

    function getPostings() {
        return JSON.parse(localStorage.getItem('horillaPostings') || '[]');
    }

    function updateToField() {
        console.log('Updating To field');
        const transferType = document.getElementById('transfer_type_request').value;
        const toContainer = document.getElementById('to-container');
        
        console.log('Transfer type:', transferType);
        console.log('To container found:', !!toContainer);

        if (!toContainer) {
            console.error('To container not found');
            return;
        }

        if (transferType === 'POSITION') {
            console.log('Showing position dropdown');
            const postings = getPostings();
            const selectHtml = `
                <select id="to-request" name="to-request" class="oh-input w-100" required>
                    <option value="">Select position</option>
                    ${postings
                        .filter(p => p.vacancy > 0)
                        .map(p => `<option value="${p.id}">${p.position_name} (${p.department}) - ${p.vacancy} vacancies</option>`)
                        .join('')}
                </select>
            `;
            toContainer.innerHTML = selectHtml;
        } else {
            console.log('Showing text input');
            const placeholder = transferType 
                ? `New ${transferType.toLowerCase()}` 
                : 'New department/position/location';
            toContainer.innerHTML = `
                <input type="text" 
                       id="to-request" 
                       name="to-request"
                       class="oh-input w-100" 
                       placeholder="${placeholder}" 
                       required>
            `;
        }
    }

    function toggleModal(modalID) {
        const modal = document.getElementById(modalID);
        if (modal) {
            modal.classList.toggle('oh-modal--show');
            if (modalID === 'createTransferRequestModal') {
                const form = document.getElementById('create-transfer-request-form');
                if (form) {
                    form.reset();
                    updateToField(); // Update fields after reset
                }
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded');
        
        // Initialize the transfer type select element
        const transferTypeSelect = document.getElementById('transfer_type_request');
        if (transferTypeSelect) {
            console.log('Transfer type select found');
            transferTypeSelect.addEventListener('change', function() {
                console.log('Transfer type changed to:', this.value);
                updateToField();
            });
        }

        // Initialize postings data
        initializePostings();
        
        // Initial field update
        updateToField();

        // Render the transfer requests table
        renderRequestsTable();
    });

    document.getElementById('save-transfer-request-btn').addEventListener('click', function() {
        const newTransfer = {
            employee: document.getElementById('employee-request').value,
            email: document.getElementById('email-request').value,
            type: document.getElementById('transfer_type_request').value,
            from: document.getElementById('from-request').value,
            to: document.getElementById('to-request').value,
            request_date: document.getElementById('request_date_request').value,
            status: 'PENDING',
            reason: document.getElementById('reason-request').value
        };

        if (!newTransfer.employee) return;
        addTransfer(newTransfer);
        document.getElementById('create-transfer-request-form').reset();
        toggleModal('createTransferRequestModal');
        renderRequestsTable();
    });
</script>
{% endblock %} 